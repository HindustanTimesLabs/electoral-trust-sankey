function draw(){function t(t,a){function s(t){function a(t){return g.filter(function(e){return e.name==t})[0].type}function r(a,r,s){$(".tip").empty(),$(".tip").show(),$(".tip").append("<div class='mobile-only tip-x'><i class='fa fa-times' aria-hidden='true'></i></div>"),$(".tip").append("<div class='tip-row'><b>"+a.source.name+"</b> gave <b>Rs "+numberLakhs(a.value)+"</b> to <b>"+a.target.name+"</b>.</div>");var u=$(".tip").width(),c=$(".tip").height(),p=$("#"+t.name).offset().top,l=r-u/2;l<=o.left?l=o.left:l+u>=i-o.right&&(l=i-o.right-u);var d=s+p-c+o.top/2-w;$(".tip").css({left:"desktop"==n?l:0,top:d,width:"desktop"==n?"auto":e})}function s(a,r){if($(".tip").show(),$(".tip").append("<div class='mobile-only tip-x'><i class='fa fa-times' aria-hidden='true'></i></div>"),$(".tip").append("<div class='title'>"+a.name+"</div>"),"trust"==r){var s=d3.sum(a.targetLinks,function(t){return t.value}),u=d3.sum(a.sourceLinks,function(t){return t.value});"General Electoral Trust"!=a.name&&"desktop"==n&&$(".tip").append("<div class='tip-row'>Received <b>Rs "+numberLakhs(s)+"</b> from <b>"+a.targetLinks.length+" "+(1==a.targetLinks.length?"company":"companies")+"</b>.</div>"),$(".tip").append("<div class='tip-row'>Gave <b>Rs "+numberLakhs(u)+"</b> to <b>"+a.sourceLinks.length+" political "+(1==a.sourceLinks.length?"party":"parties")+"</b>.</div>")}else if("company"==r){var u=d3.sum(a.sourceLinks,function(t){return t.value});$(".tip").append("<div class='tip-row'>Gave <b>Rs "+numberLakhs(u)+"</b> to <b>"+a.sourceLinks[0].target.name+"</b>.</div>")}else if("party"==r){var s=d3.sum(a.targetLinks,function(t){return t.value});"General Electoral Trust"!=a.name&&$(".tip").append("<div class='tip-row'>Received <b>Rs "+numberLakhs(s)+"</b> from <b>"+a.targetLinks.length+" "+(1==a.targetLinks.length?"desktop"==n?"trust":"company":"desktop"==n?"trusts":"companies")+"</b>.</div>")}var c=$(".tip").width(),p=$(".tip").height();p=p>90?p-36:p;var l=$("#"+t.name).offset().top,d="trust"==r?a.x-c/2:"company"==r?o.left:"party"==r?i-o.right-c:null,m=a.y-p+l+o.top/2-w;$(".tip").css({left:"desktop"==n?d:0,top:m,width:"desktop"==n?"auto":e})}function m(){$(".tip").empty(),$(".tip").hide()}var f=d[t.data],y=[];f.forEach(function(t){y.push(t.source),y.push(t.target)});var v=y.filter(onlyUnique).map(function(t,e){return{node:e,name:t}}),h=f.map(function(t){function e(e){return v.filter(function(n){return n.name==t[e]})[0].node}return{source:e("source"),target:e("target"),value:+t.value}});p.nodes(v).links(h).layout(32);var g=v.map(function(t){var e={};e.name=t.name;var n=f.filter(function(e){return e.source==t.name})[0];return void 0===n?e.type="party":"party"==n.recipient_type?e.type="trust":"trust"==n.recipient_type&&(e.type="company"),e}),k=c[t.name].append("g").selectAll(".link").data(h).enter().append("path").attr("class",function(t){a(t.source.name);return"link "+slugify(t.source.name)+" "+slugify(t.target.name)}).attr("d",l).style("stroke-opacity",opacity.mouseout).style("stroke",function(t){return u("trust"==a(t.source.name)?t.source.name.replace(/ .*/,""):t.target.name.replace(/ .*/,""))}).style("stroke-width",function(t){return Math.max(1,t.dy)}).sort(function(t,e){return e.dy-t.dy});k.on("mouseover",function(t){"Unknown"==t.source.name||d3.select(this).style("stroke-opacity",opacity.mouseover).moveToFront()}).on("mousemove",function(t){if("Unknown"==t.source.name)m();else{var e=[0,0];e=d3.mouse(this);r(t,e[0],e[1])}}).on("mouseout",function(t){d3.selectAll(".link").style("stroke-opacity",opacity.mouseout),m()}),$(document).on("click touchstart",".tip",function(){d3.selectAll(".link").style("stroke-opacity",opacity.mouseout),m()});var b=c[t.name].append("g").selectAll(".node").data(v).enter().append("g").attr("class",function(t){return"node "+slugify(t.name)}).attr("transform",function(t){return"translate("+t.x+","+t.y+")"});b.append("rect").attr("height",function(t){return t.dy<=2?2:t.dy}).attr("width",p.nodeWidth()).style("fill",function(t){var e=a(t.name);return"trust"==e?t.color=u(t.name.replace(/ .*/,"")):"company"==e?t.color=u(t.sourceLinks[0].target.name.replace(/ .*/,"")):"desktop"==n?t.color="#ccc":t.name.indexOf("Trust")==-1?t.color="#ccc":u(t.name.replace(/ .*/,""))}).style("stroke",function(t){return d3.rgb(t.color).darker(.3)}),b.append("text").attr("x",-6).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).style("font-size",function(t){return"trust"==a(t.name)?"desktop"==n?".9em":".7em":t.dy>=25?".7em":".6em"}).text(function(t){return t.name}).filter(function(t){return t.x<i/2}).attr("x",6+p.nodeWidth()).attr("text-anchor","start"),b.on("mouseover",function(t){var e=a(t.name);"Unknown"==t.name&&"company"==e?m():(s(t,e),d3.selectAll(".link."+slugify(t.name)).style("stroke-opacity",opacity.mouseover).moveToFront(),d3.selectAll(".link.unknown").style("stroke-opacity",opacity.mouseout))}).on("mouseout",function(t){d3.selectAll(".link").style("stroke-opacity",opacity.mouseout),m()});var w="desktop"==n?0:10}var d={csv_all:a,mob_1:a.filter(function(t){return"trust"==t.recipient_type}),mob_2:a.filter(function(t){return"party"==t.recipient_type})};r.forEach(function(t){s(t)})}var e=$(window).width(),n=e<=768?"mobile":"desktop";$(".tip").remove(),$("body").append("<div class='tip'></div>"),$(".tip").hide();var a={desktop:[{name:"viz",data:"csv_all"}],mobile:[{name:"viz-mob-1",data:"mob_1"},{name:"viz-mob-2",data:"mob_2"}]},r=a[n];r.forEach(function(t){$("#"+t.name).empty()});var o={top:"desktop"==n?50:20,right:10,bottom:10,left:10},i=window.innerWidth-o.left-o.right,s=("desktop"==n?700:500)-o.top-o.bottom,u=(d3.format(",.0f"),function(t){return"Bajaj"==t?"#e23fa7":"General"==t?"#e27a3f":"Satya"==t?"#2980b9":"Triumph"==t?"#df5a49":"Janpragati"==t?"#45b29d":"Progressive"==t?"#efc94c":"Samaj"==t?"#783fe2":void 0}),c={};r.forEach(function(t){c[t.name]=d3.select("#"+t.name).append("svg").attr("width",i+o.left+o.right).attr("height",s+o.top+o.bottom).append("g").attr("transform","translate("+o.left+","+o.top+")")});var p=d3.sankey().nodeWidth(10).nodePadding(8).size([i,s]),l=p.link(),d=[{text:"Companies",x:0,achor:"start",tspan:" gave money to..."},{text:"...electoral trusts",x:i/2,anchor:"middle",tspan:", which gave money to..."},{text:"...political parties.",x:i,anchor:"end",tspan:""}];r.forEach(function(t){c[t.name].selectAll(".top-label").data(d).enter().append("text").attr("class","top-label").attr("x",function(t){return t.x}).attr("y",20-o.top).attr("text-anchor",function(t){return t.anchor}).text(function(t){return t.text}).append("tspan").text(function(t){return t.tspan})}),d3.queue().defer(d3.csv,"sankey_all.csv").await(t)}function onlyUnique(t,e,n){return n.indexOf(t)===e}function slugify(t){return t.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}function numberLakhs(t){t=t.toString();var e=t.indexOf(".")>0?t.substring(t.indexOf("."),t.length):"";t=Math.floor(t).toString();var n=t.substring(t.length-3),a=t.substring(0,t.length-3);return n=""!=a?","+n:n,a.replace(/\B(?=(\d{2})+(?!\d))/g,",")+n+e}var opacity={mouseover:1,mouseout:.4};window.onload=draw,$(window).smartresize(draw);